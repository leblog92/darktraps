<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Dark Traps</title>
<style>
	html,body{
	height:100%;
	margin:0;
	}
	body{
		background: linear-gradient(135deg, rgba(0,0,0,1), rgba(0,0,0,0.8), rgba(0,0,0,1)), url("floor.png");
		font-family:Consolas;
		text-align:center;
	}
	.main {
		height:100%;
		width:100%;
		display:table;
	}
	.wrapper {
		display:table-cell;
		height:100%;
		vertical-align: middle;
	}
	#div1{
		background:rgba(255,255,255,0.25);
		text-align:left;
		position:fixed;
		top:8px;
		left:8px;
		padding:8px;
		user-select:none;
		border-radius:8px;
	}
	#svg1{
		width:900px;
		height:900px;
		box-shadow:10px 10px 20px rgba(0,0,0,0.5);
		cursor:crosshair;
	}
	#doorL,#doorR{
		transition:6s;
	}
	#scale1{
		transition:3s;
	}
	#light{
		transition:3s;
	}
	#torchlight{
		transition:r 3s;
	}
	#ray{
		transition:stroke-width 3s;
	}
	#title{
		transition:6s;
	}
	#start{
		transition:1s;
	}
	g[id^="img_"]{
		transition:opacity linear 400ms 1s;
	}
</style>
</head>
<body>
<audio id="step">
	<source src="step.mp3" type="audio/mpeg">
</audio>
<audio id="tune" loop>
	<source src="tune1.mp3" type="audio/mpeg">
</audio>
<div id="div1">DARK TRAPS</div>
<div class="main">
<div class="wrapper">
<svg id="svg1" viewBox="0 0 900 900">
<defs>
	<filter height="200%" width="200%" y="-50%" x="-50%" id="f1">
		<feGaussianBlur stdDeviation="25" in="SourceGraphic"/>
	</filter>
	<mask id="hide">
		<rect x="0" y="0" width="900" height="900" fill="#fff"/>
		<g filter="url(#f1)">
			<path d="m450 850L450 850" stroke-width="0" fill="none" stroke="#999" id="ray" stroke-linecap="round"/>
			<g transform="translate(450 850)" id="position_light">
				<circle opacity="1" cx="0" cy="0" r="0" fill="#999" id="light"/>
			</g>
			<g transform="translate(450 850)" id="torchlight_position">
				<circle cx="0" cy="0" r="0" fill="#000" id="torchlight"/>
			</g>
		</g>
	</mask>
</defs>

<image x="0" y="0" width="900" height="900" xlink:href="floor.png"/>

<g transform="translate(450 850)" id="player">
	<g transform="rotate(-90 0 0)" id="rotate1">
		<image x="-50" y="-50" width="100" height="100" xlink:href="player.gif"/>
	</g>
</g>

<rect x="0" y="0" width="900" height="900" fill="#000" opacity="1" style="mask:url(#hide)"/>

<g id="monster_area"></g>

<g id="start" transform="translate(450 450)">
	<g transform="scale(1)" id="scale1">
		<g transform="translate(0 0)" id="doorL">
			<image x="-450" y="-450" width="900" height="900" xlink:href="doorL.png"/>
		</g>
		<g transform="translate(0 0)" id="doorR">
			<image x="-450" y="-450" width="900" height="900" xlink:href="doorR.png"/>
		</g>
			<image x="-450" y="-450" width="900" height="900" xlink:href="arch.png" id="arch"/>
			<image x="-450" y="-450" width="900" height="900" xlink:href="shade.png" id="shade"/>
			<image x="-450" y="-450" width="900" height="900" xlink:href="title.png" id="title" opacity="0.5"/>
			<image x="-450" y="-450" width="900" height="900" xlink:href="fog.png" id="fog" opacity="0.4"/>
	</g>
</g>
</svg>
</div>
</div>

<script>
	var ww=window.innerWidth;
	var wh=window.innerHeight;
	var div1=document.getElementById("div1");
	var svg1=document.getElementById("svg1");
	var start=document.getElementById("start");
	var doorL=document.getElementById("doorL");
	var doorR=document.getElementById("doorR");
	var arch=document.getElementById("arch");
	var shade=document.getElementById("shade");
	var scale1=document.getElementById("scale1");
	var player=document.getElementById("player");
	var position_light=document.getElementById("position_light");
	var light=document.getElementById("light");
	var torchlight=document.getElementById("torchlight");
	var torchlight_position=document.getElementById("torchlight_position");
	var ray=document.getElementById("ray");
	var step=document.getElementById("step");
	var tune=document.getElementById("tune");
	var title=document.getElementById("title");
	var monster_area=document.getElementById("monster_area");
	var bound=svg1.getBoundingClientRect();
	var bound_left=Math.round(bound.left);
	var bound_top=Math.round(bound.top);
	var mx=450;
	var my=850;
	x=450;
	y=850;

	document.addEventListener("click",open);

	function open(){
		document.removeEventListener("click",open);
		new Audio("open.mp3").play();
		doorL.setAttribute("transform","translate(-450 0)");
		doorR.setAttribute("transform","translate(450 0)");
		title.setAttribute("transform","translate(0 -450)");
		setTimeout(function(){
			tune.volume=0.4;
			tune.play();
			light.setAttribute("r","90");
			torchlight.setAttribute("r","100");
			ray.setAttribute("stroke-width","150");
			scale1.setAttribute("transform","scale(3)");
			setTimeout(function(){
				start.setAttribute("opacity","0");
					setTimeout(function(){
						scale1.setAttribute("transform","scale(1)");
						start.setAttribute("transform","translate(450 -450)");
						setTimeout(function(){
							start_move();
							create_monsters();
						},500);
					},1000);
			},1000);
		},3000);
	}

	function start_move(){
		var x=450,
			y=850,
			velY=0,
			velX=0,
			speed=4,
			friction=0.9,
			keys=[];

		function update(){
			requestAnimationFrame(update);

			if (keys[90]) {
				if (velY > -speed) {
					velY--;
				}
			}
			
			if (keys[83]) {
				if (velY < speed) {
					velY++;
				}
			}
			if (keys[68]) {
				if (velX < speed) {
					velX++;
				}
			}
			if (keys[81]) {
				if (velX > -speed) {
					velX--;
				}
			}

			velY *= friction;
			y += Math.round(velY);
			velX *= friction;
			x += Math.round(velX);

			if (x >= 850) {
				x = 850;
			} else if (x <= 50) {
				x = 50;
			}

			if (y > 850) {
				y = 850;
			} else if (y <= 50) {
				y = 50;
			}

			player.setAttribute("transform","translate("+x+","+y+")");
			position_light.setAttribute("transform","translate("+x+","+y+")");
			ray.setAttribute("d", "m"+x+" "+y+"L"+mx+" "+my);
			p1={x:x,y:y};
			p2={x:mx,y:my};
			angleDeg=Math.round(Math.atan2(p2.y-p1.y,p2.x-p1.x)*180/Math.PI);
			rotate1.setAttribute("transform","rotate("+angleDeg+" 0 0)");
			dist=Math.round(Math.getDistance(x,y,mx,my));
			div1.innerHTML="DARK TRAPS<br>window width: "+ww+"px height: "+wh+"px<br>player x: "+x+" y: "+y+"<br>mouse x: "+mx+" y: "+my+"<br>angle: "+angleDeg+"Â°<br>bounding left: "+bound_left+"px top: "+bound_top+"px<br>distance: "+dist+"px";
		}

		update();

		document.body.addEventListener("keydown",function(e){
			keys[e.keyCode] = true;
			if (keys[68]||keys[81]||keys[83]||keys[90])step.play();
		});

		document.body.addEventListener("keyup",function(e){
			keys[e.keyCode] = false;
		});

	}

	function showCoords(event){
		mx=Math.round(event.clientX-bound_left);
		my=Math.round(event.clientY-bound_top);
		torchlight_position.setAttribute("transform", "translate("+mx+" "+my+")");
		ray.setAttribute("d", "m"+x+" "+y+"L"+mx+" "+my);
	}

	svg1.addEventListener("mousemove", event => {showCoords(event);});

	Math.getDistance=function(x1,y1,x2,y2){
		var xs=x2-x1,ys=y2-y1;		
		xs*=xs;
		ys*=ys;
		return Math.sqrt(xs+ys);
	};

	var max=1;
	function create_monsters(){
		new Audio("appear.mp3").play();
		for(var i=0;i<max;i++){
				xm=Math.round(((Math.random()*900)));
				ym=Math.round(((Math.random()*900)));
					while(Math.getDistance(x,y,xm,ym)<300){
						xm=Math.round(((Math.random()*900)));ym=Math.round(((Math.random()*900)));
					}
				g=document.createElementNS(svg1.namespaceURI,"g");
				if(x<10){xm="0"+xm};if(ym<10){ym="0"+ym};
				g.setAttribute("transform","translate("+xm+" "+ym+")");
				g.setAttribute("class","spider");
				g.setAttribute("id","idm_"+i);
				monster=document.createElementNS(svg1.namespaceURI,"image");
				monster.setAttributeNS("http://www.w3.org/1999/xlink","href","monster.gif");
				monster.setAttribute("x",-50);
				monster.setAttribute("y",-50);
				p1={x:x,y:y};
				mp2={x:xm+100,y:ym+100};
				monster.setAttribute("transform","rotate("+Math.round(Math.atan2(mp2.y-p1.y,mp2.x-p1.x)*180/Math.PI)+" 0 0)");
				monster.setAttribute("width",100);
				monster.setAttribute("height",100);
				monster.setAttribute("opacity",1);
				monster.setAttribute("id","img_"+i);
				monster_area.appendChild(g);
				g.appendChild(monster);
		}
	}
</script>
</body>
</html>
